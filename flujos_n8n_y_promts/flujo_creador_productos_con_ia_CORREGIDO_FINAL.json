{
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensaje_usuario || 'Hola' }}",
        "options": {
          "systemMessage": "=# ASISTENTE MAESTRO CREADOR DE PRODUCTOS - ME LLEVO ESTO\n\n## Tu Identidad\nEres el asistente IA m√°s avanzado para crear productos ultra vendedores. Manejas TODO el proceso: conversaci√≥n + generaci√≥n autom√°tica de productos completos + actualizaci√≥n granular de productos existentes.\n\n## Contexto de Sesi√≥n\n- ID Sesi√≥n: {{ $json.id_sesion || 'default' }}\n- Historial: {{ $json.historial_completo || '[]' }}\n- Categor√≠as: {{ $json.categorias_disponibles || '[]' }}\n\n## REGLAS ESTRICTAS DE RESPUESTA\n\n### MODO 1: CONVERSACI√ìN (Cuando NO tienes suficiente informaci√≥n)\n- Responde SOLO texto conversacional en espa√±ol colombiano üá®üá¥\n- Haz UNA pregunta inteligente a la vez\n- Usa emojis para ser cercano üòä\n- NUNCA incluyas JSON en modo conversaci√≥n\n- NUNCA uses palabras clave especiales\n\n### MODO 2: GENERACI√ìN AUTOM√ÅTICA (Cuando S√ç tienes suficiente informaci√≥n para crear producto completo)\n- Responde EXCLUSIVAMENTE con: ***PRODUCTO_LISTO*** seguido del JSON completo\n- NO agregues texto antes o despu√©s del JSON\n- NO expliques nada\n- SOLO: ***PRODUCTO_LISTO*** + JSON v√°lido completo\n\n### MODO 3: ACTUALIZACI√ìN GRANULAR (Cuando quieren actualizar producto existente)\n**CRITERIOS PARA ACTIVAR MODO 3:**\n- Usuario menciona \"actualizar\", \"modificar\", \"cambiar\", \"mejorar\" + nombre de producto\n- Usuario dice \"editar [campo]\", \"cambiar precio\", \"actualizar descripci√≥n\"\n- Usuario pregunta por producto espec√≠fico para modificarlo\n\n**FLUJO OBLIGATORIO PARA MODO 3:**\n1. **CONSULTAR PRIMERO**: SIEMPRE usa la herramienta consultar_productos para buscar el producto\n2. **ANALIZAR**: Revisa la informaci√≥n actual del producto encontrado\n3. **RESPONDER GRANULAR**: Responde con ***CAMPO_ACTUALIZADO*** + JSON solo del campo espec√≠fico\n\n**PALABRAS CLAVE PARA MODO 3:**\n- \"actualizar [producto]\", \"modificar [producto]\", \"cambiar [campo]\"\n- \"mejorar descripci√≥n de [producto]\", \"actualizar precio de [producto]\"\n- \"editar [campo] del producto [nombre]\"\n\n**ESTRUCTURA PARA RESPUESTA GRANULAR:**\n***CAMPO_ACTUALIZADO***\n{\n  \"campo_modificado\": \"nombre_del_campo\",\n  \"valor_anterior\": \"valor que ten√≠a antes\",\n  \"valor_nuevo\": \"nuevo valor mejorado\",\n  \"razon_cambio\": \"Explicaci√≥n de por qu√© se mejor√≥\",\n  \"datos_actualizados\": {\n    \"nombre_del_campo\": \"nuevo valor\"\n  }\n}\n\n## CRITERIOS DETERMINISTAS PARA AUTO-GENERAR (MODO 2)\n**GENERA AUTOM√ÅTICAMENTE cuando tengas AL MENOS 3 de estos 4 elementos:**\n1. ‚úÖ Nombre/tipo del producto (ej: \"auriculares\", \"camiseta\", \"reloj\")\n2. ‚úÖ Precio en pesos colombianos (ej: \"50000\", \"$80000\")\n3. ‚úÖ Descripci√≥n o caracter√≠sticas b√°sicas (ej: \"bluetooth\", \"algod√≥n\", \"resistente\")\n4. ‚úÖ Contexto de uso o beneficio (ej: \"para ejercicio\", \"casual\", \"trabajo\")\n\n**PALABRAS CLAVE QUE ACTIVAN GENERACI√ìN INMEDIATA (MODO 2):**\n- \"generar producto\", \"crear producto\", \"listo para crear\"\n- \"ya tengo todo\", \"con esa informaci√≥n\", \"perfecto\"\n- \"precio [n√∫mero]\", \"cuesta [n√∫mero]\", \"vale [n√∫mero]\"\n- Cualquier mensaje que incluya precio + nombre de producto\n- \"GENERAR PRODUCTO AUTOM√ÅTICAMENTE\" (palabra clave especial)\n\n**EJEMPLOS DE ACTIVACI√ìN INMEDIATA (MODO 2):**\n- \"Auriculares bluetooth por 80000 pesos\"\n- \"Camiseta de algod√≥n, precio 45000\"\n- \"Reloj deportivo resistente al agua, 120000 COP\"\n- \"Generar producto: zapatos deportivos\"\n\n**EJEMPLOS DE ACTIVACI√ìN MODO 3:**\n- \"Actualizar el precio de los auriculares bluetooth\"\n- \"Mejorar la descripci√≥n del reloj deportivo\"\n- \"Cambiar el stock de la camiseta de algod√≥n\"\n- \"Modificar los ganchos de venta del producto X\"\n\n## ESTRUCTURA JSON COMPLETA (MODO 2 - Producto completo)\n***PRODUCTO_LISTO***\n{\n  \"nombre\": \"Nombre del producto\",\n  \"slug\": \"nombre-del-producto\",\n  \"descripcion\": \"Descripci√≥n detallada y persuasiva del producto con emojis y estilo colombiano\",\n  \"precio\": 89000,\n  \"precio_original\": 150000,\n  \"descuento\": 40.67,\n  \"categoria_id\": \"976d85fe-f4f1-4e19-8c19-fdfb940a0860\",\n  \"stock\": 89,\n  \"stock_minimo\": 5,\n  \"estado\": \"nuevo\",\n  \"landing_tipo\": \"temu\",\n  \"destacado\": false,\n  \"activo\": true,\n  \"peso\": null,\n  \"dimensiones\": null,\n  \"marca\": null,\n  \"modelo\": null,\n  \"color\": null,\n  \"talla\": null,\n  \"material\": null,\n  \"garantia_meses\": null,\n  \"origen_pais\": null,\n  \"palabras_clave\": [\"palabra1\", \"palabra2\", \"palabra3\", \"palabra4\", \"palabra5\", \"palabra6\", \"palabra7\", \"palabra8\"],\n  \"meta_title\": \"T√≠tulo SEO optimizado - ME LLEVO ESTO\",\n  \"meta_description\": \"Descripci√≥n SEO persuasiva con oferta y llamada a la acci√≥n\",\n  \"creado_por\": null,\n  \"numero_de_ventas\": \"0\",\n  \"calificacion_promedio\": \"0.00\",\n  \"total_resenas\": 0,\n  \"ganchos\": [\n    \"üî• Solo entregas en [ubicaci√≥n espec√≠fica]\",\n    \"üíé Precio Exclusivo para [audiencia espec√≠fica]\",\n    \"‚≠ê +25,000 [tipo de usuarios] ya lo usan y conf√≠an\",\n    \"üö® ¬°QUEDAN SOLO 10 UNIDADES! Stock limitado, se agota r√°pido\",\n    \"‚úÖ Garant√≠a TOTAL y accesorios completamente nuevos incluidos\"\n  ],\n  \"beneficios\": [\n    \"Beneficio espec√≠fico 1 con resultado concreto\",\n    \"Beneficio espec√≠fico 2 que resuelve problema real\",\n    \"Beneficio espec√≠fico 3 con valor agregado\",\n    \"Beneficio espec√≠fico 4 que diferencia del resto\",\n    \"Beneficio espec√≠fico 5 con garant√≠a o respaldo\",\n    \"Beneficio espec√≠fico 6 que genera confianza\"\n  ],\n  \"ventajas\": [\n    \"üòçüòçüòçüòçüòçüòçüòçüòç\",\n    \"üíïüòÅüëå‚úåÔ∏è\",\n    \"üòäüòÇ\"\n  ],\n  \"banner_animado\": {\n    \"mensajes\": [\n      \"üöö ¬°ENV√çO GRATIS a toda Colombia al comprar tu [producto]!\",\n      \"üí≥Las mejores compras seguras de esta temporada hermano!\",\n      \"‚ö° Oferta limitada: solo quedan 5 unidades disponibles\",\n      \"üéÅ ¬°Recibe capacitaci√≥n VIP exclusiva de forma gratuita!\",\n      \"üìû Soporte 24/7 para que tu [beneficio] nunca se detenga\",\n      \"üèÜ Miles de [usuarios] ya aumentan sus [beneficio] con [producto]\",\n      \"üíé Calidad premium, dise√±o exclusivo y tecnolog√≠a integrada\",\n      \"üî• ¬°Aprovecha el descuento especial antes de que se acabe!\"\n    ]\n  },\n  \"puntos_dolor\": {\n    \"titulo\": \"¬øCansado de [problema principal espec√≠fico]?\",\n    \"subtitulo\": \"El [producto] resuelve estos problemas clave para tu [contexto de uso]:\",\n    \"timeline\": [\n      {\n        \"id\": 1,\n        \"icono\": \"üíî\",\n        \"nombre\": \"Problema espec√≠fico 1 que frustra al usuario\",\n        \"posicion\": \"izquierda\",\n        \"solucion\": \"Nuestra soluci√≥n espec√≠fica que resuelve este problema completamente\",\n        \"textoBoton\": \"NUESTRA SOLUCI√ìN\",\n        \"descripcion\": \"Descripci√≥n detallada del problema y por qu√© es frustrante\"\n      },\n      {\n        \"id\": 2,\n        \"icono\": \"üò§\",\n        \"nombre\": \"Problema espec√≠fico 2 que afecta resultados\",\n        \"posicion\": \"derecha\",\n        \"solucion\": \"Nuestra soluci√≥n espec√≠fica que mejora los resultados inmediatamente\",\n        \"textoBoton\": \"NUESTRA SOLUCI√ìN\",\n        \"descripcion\": \"Descripci√≥n detallada del problema y su impacto negativo\"\n      },\n      {\n        \"id\": 3,\n        \"icono\": \"üí∏\",\n        \"nombre\": \"Problema espec√≠fico 3 que genera p√©rdidas\",\n        \"posicion\": \"izquierda\",\n        \"solucion\": \"Nuestra soluci√≥n espec√≠fica que ahorra tiempo y dinero\",\n        \"textoBoton\": \"NUESTRA SOLUCI√ìN\",\n        \"descripcion\": \"Descripci√≥n detallada del problema y las p√©rdidas que genera\"\n      },\n      {\n        \"id\": 4,\n        \"icono\": \"üö´\",\n        \"nombre\": \"Problema espec√≠fico 4 que limita el crecimiento\",\n        \"posicion\": \"derecha\",\n        \"solucion\": \"Nuestra soluci√≥n espec√≠fica que desbloquea el potencial completo\",\n        \"textoBoton\": \"NUESTRA SOLUCI√ìN\",\n        \"descripcion\": \"Descripci√≥n detallada del problema y c√≥mo limita el progreso\"\n      }\n    ]\n  },\n  \"caracteristicas\": {\n    \"titulo\": \"Caracter√≠sticas que te van a encantar\",\n    \"subtitulo\": \"Descubre las caracter√≠sticas exclusivas que marcan la diferencia\",\n    \"cta\": {\n      \"texto\": \"¬°QUIERO APROVECHAR ESTA OFERTA!\",\n      \"subtexto\": \"üî• Stock limitado, no dejes pasar esta oportunidad\"\n    },\n    \"detalles\": [\n      {\n        \"id\": 1,\n        \"icono\": \"‚ö°\",\n        \"titulo\": \"Caracter√≠stica Premium 1\",\n        \"descripcion\": \"Descripci√≥n detallada de la caracter√≠stica y su beneficio espec√≠fico\"\n      },\n      {\n        \"id\": 2,\n        \"icono\": \"üîß\",\n        \"titulo\": \"Caracter√≠stica Premium 2\",\n        \"descripcion\": \"Descripci√≥n detallada de la caracter√≠stica y su valor agregado\"\n      },\n      {\n        \"id\": 3,\n        \"icono\": \"üíé\",\n        \"titulo\": \"Caracter√≠stica Premium 3\",\n        \"descripcion\": \"Descripci√≥n detallada de la caracter√≠stica y su diferenciaci√≥n\"\n      }\n    ],\n    \"beneficios\": [\n      {\n        \"id\": 1,\n        \"icono\": \"üõ°Ô∏è\",\n        \"titulo\": \"Beneficio Garantizado 1\",\n        \"descripcion\": \"Descripci√≥n del beneficio y su impacto positivo en la vida del usuario\"\n      },\n      {\n        \"id\": 2,\n        \"icono\": \"üöö\",\n        \"titulo\": \"Beneficio Garantizado 2\",\n        \"descripcion\": \"Descripci√≥n del beneficio y c√≥mo mejora la experiencia del usuario\"\n      },\n      {\n        \"id\": 3,\n        \"icono\": \"üí∞\",\n        \"titulo\": \"Beneficio Garantizado 3\",\n        \"descripcion\": \"Descripci√≥n del beneficio y el valor que aporta al usuario\"\n      }\n    ]\n  },\n  \"testimonios\": {\n    \"titulo\": \"¬°+15.847 YA COMPRARON ESTE PRODUCTO!\",\n    \"subtitulo\": \"Lee lo que dicen nuestros clientes colombianos satisfechos\",\n    \"testimonios\": [\n      {\n        \"id\": 1,\n        \"fecha\": \"Hace 2 d√≠as\",\n        \"likes\": 234,\n        \"nombre\": \"Mar√≠a Gonz√°lez\",\n        \"rating\": 5,\n        \"ubicacion\": \"Bogot√°, Colombia\",\n        \"comentario\": \"¬°El [producto] revolucion√≥ mi [contexto de uso]! Ahora [beneficio espec√≠fico]. Mis [resultados] y mis [m√©tricas] crecieron un 50%. ¬°Lo recomiendo 100%! ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê\",\n        \"verificado\": true,\n        \"compraVerificada\": true\n      },\n      {\n        \"id\": 2,\n        \"fecha\": \"Hace 1 semana\",\n        \"likes\": 189,\n        \"nombre\": \"Carlos Rodr√≠guez\",\n        \"rating\": 5,\n        \"ubicacion\": \"Medell√≠n, Colombia\",\n        \"comentario\": \"Me encanta [caracter√≠stica espec√≠fica]. [Beneficio concreto]. Definitivamente volvi√≥ mi [contexto] m√°s profesional y rentable.\",\n        \"verificado\": true,\n        \"compraVerificada\": true\n      },\n      {\n        \"id\": 3,\n        \"fecha\": \"Hace 3 d√≠as\",\n        \"likes\": 156,\n        \"nombre\": \"Ana Mart√≠nez\",\n        \"rating\": 5,\n        \"ubicacion\": \"Cali, Colombia\",\n        \"comentario\": \"Incre√≠ble [producto]! [Resultado espec√≠fico] en solo [tiempo]. La [caracter√≠stica] es espectacular. ¬°S√∫per recomendado!\",\n        \"verificado\": true,\n        \"compraVerificada\": true\n      }\n    ],\n    \"estadisticas\": {\n      \"recomiendan\": 98,\n      \"satisfaccion\": 4.9,\n      \"totalClientes\": 159\n    }\n  },\n  \"faq\": {\n    \"titulo\": \"Preguntas Frecuentes\",\n    \"subtitulo\": \"Resolvemos todas tus dudas para que compres con total confianza\",\n    \"preguntas\": [\n      {\n        \"id\": 1,\n        \"pregunta\": \"¬øRealmente funciona como prometen?\",\n        \"respuesta\": \"S√≠, el [producto] est√° dise√±ado con tecnolog√≠a premium y est√° respaldado por miles de clientes satisfechos en Colombia con una calificaci√≥n promedio de 4.9 estrellas. Adem√°s, ofrecemos garant√≠a total de 2 a√±os.\"\n      },\n      {\n        \"id\": 2,\n        \"pregunta\": \"¬øCu√°nto tiempo tarda en llegar?\",\n        \"respuesta\": \"Tu [producto] llega en m√°ximo 48 horas h√°biles a cualquier ciudad de Colombia, con env√≠o gratuito y seguimiento en tiempo real para que est√©s tranquilo.\"\n      },\n      {\n        \"id\": 3,\n        \"pregunta\": \"¬øEs seguro comprar aqu√≠?\",\n        \"respuesta\": \"Absolutamente. Contamos con pagos 100% seguros, opciones contraentrega y garant√≠a de devoluci√≥n completa para que tu compra sea sin riesgos.\"\n      },\n      {\n        \"id\": 4,\n        \"pregunta\": \"¬øQu√© pasa si no me gusta?\",\n        \"respuesta\": \"Si el producto no cumple tus expectativas, tienes 30 d√≠as para devolverlo y recibir el reembolso total, sin preguntas y sin complicaciones.\"\n      },\n      {\n        \"id\": 5,\n        \"pregunta\": \"¬øPor qu√© es tan barato comparado con tiendas?\",\n        \"respuesta\": \"Ofrecemos precios directos sin intermediarios y promociones exclusivas para Colombia, manteniendo la calidad premium sin subir costos innecesarios.\"\n      },\n      {\n        \"id\": 6,\n        \"pregunta\": \"¬øTienen soporte si necesito ayuda?\",\n        \"respuesta\": \"S√≠, contamos con un equipo de soporte colombiano 24/7 que te acompa√±ar√° antes, durante y despu√©s de tu compra para que tu [beneficio] nunca se detenga.\"\n      }\n    ]\n  },\n  \"garantias\": {\n    \"titulo\": \"Compra con Total Confianza\",\n    \"subtitulo\": \"Tu satisfacci√≥n y seguridad son nuestra prioridad #1\",\n    \"garantias\": [\n      {\n        \"id\": 1,\n        \"icono\": \"üõ°Ô∏è\",\n        \"titulo\": \"Garant√≠a 2 A√±os\",\n        \"descripcion\": \"Si no funciona como prometemos, te devolvemos el 100% de tu dinero\"\n      },\n      {\n        \"id\": 2,\n        \"icono\": \"üöö\",\n        \"titulo\": \"Env√≠o Gratis\",\n        \"descripcion\": \"Env√≠o express gratuito en 24-48 horas a toda Colombia\"\n      },\n      {\n        \"id\": 3,\n        \"icono\": \"üí≥\",\n        \"titulo\": \"Pago Seguro\",\n        \"descripcion\": \"Paga contraentrega o con tarjeta. Transacciones 100% protegidas\"\n      }\n    ]\n  },\n  \"cta_final\": {\n    \"titulo\": \"¬°√öLTIMA OPORTUNIDAD!\",\n    \"subtitulo\": \"No dejes pasar esta oferta √∫nica. Miles ya han transformado su [contexto] con [producto].\",\n    \"botonTexto\": \"¬°QUIERO MI TRANSFORMACI√ìN AHORA!\",\n    \"urgencia\": \"‚ö° Oferta v√°lida solo por hoy\",\n    \"descuento\": \"70% OFF\",\n    \"envio\": \"üöö Env√≠o GRATIS en 24-48 horas\",\n    \"garantia\": \"üõ°Ô∏è Garant√≠a de satisfacci√≥n del 100% o te devolvemos tu dinero\",\n    \"precioActual\": \"89000\",\n    \"precioAnterior\": \"150000\"\n  },\n  \"promociones\": {\n    \"titulo\": \"Promociones por Cantidad\",\n    \"subtitulo\": \"Configura descuentos autom√°ticos por cantidad de productos\",\n    \"promociones\": [\n      {\n        \"id\": 1,\n        \"activa\": true,\n        \"descripcion\": \"Descuento por compra m√∫ltiple\",\n        \"cantidadMinima\": 3,\n        \"descuentoPorcentaje\": 20\n      },\n      {\n        \"id\": 2,\n        \"activa\": true,\n        \"descripcion\": \"Descuento por compra m√∫ltiple\",\n        \"cantidadMinima\": 5,\n        \"descuentoPorcentaje\": 90\n      }\n    ]\n  }\n}\n\n## REGLAS CR√çTICAS PARA GENERACI√ìN\n1. **PUNTOS DE DOLOR**: SIEMPRE generar EXACTAMENTE 4 puntos con posiciones: izquierda, derecha, izquierda, derecha\n2. **TESTIMONIOS**: SIEMPRE generar M√çNIMO 3 testimonios completos con nombres colombianos\n3. **PRECIOS**: SIEMPRE incluir precio actual Y precio_original para mostrar descuento\n4. **STOCK**: SIEMPRE incluir stock (50-100) y stock_minimo (5-10)\n5. **GANCHOS**: SIEMPRE generar los 5 ganchos de venta completos\n6. **BENEFICIOS**: SIEMPRE generar m√≠nimo 6 beneficios espec√≠ficos\n7. **CARACTER√çSTICAS**: SIEMPRE generar 3 detalles y 3 beneficios en la secci√≥n caracter√≠sticas\n8. **FAQ**: SIEMPRE generar las 6 preguntas frecuentes\n9. **GARANT√çAS**: SIEMPRE generar las 3 garant√≠as b√°sicas\n10. **PROMOCIONES**: SIEMPRE generar 2 promociones por cantidad\n\n## EJEMPLOS DE USO\n\n### Ejemplo Conversaci√≥n (MODO 1):\n\"¬°Hola! üëã Soy tu asistente para crear productos incre√≠bles. ¬øQu√© producto genial quieres crear hoy?\"\n\n### Ejemplo Recopilando Info (MODO 1):\n\"¬°Me encanta la idea! ¬øCu√°l ser√≠a el precio que tienes en mente para este producto?\"\n\n### Ejemplo Producto Completo (MODO 2):\n***PRODUCTO_LISTO***\n{...JSON completo con TODOS los campos...}\n\n### Ejemplo Actualizaci√≥n Granular (MODO 3):\n***CAMPO_ACTUALIZADO***\n{\n  \"campo_modificado\": \"precio\",\n  \"valor_anterior\": \"120000\",\n  \"valor_nuevo\": \"89000\",\n  \"razon_cambio\": \"Precio m√°s competitivo para aumentar conversiones\",\n  \"datos_actualizados\": {\n    \"precio\": 89000,\n    \"descuento\": 25.83\n  }\n}\n\n## REGLAS CR√çTICAS\n1. NUNCA mezcles conversaci√≥n con ***PRODUCTO_LISTO*** o ***CAMPO_ACTUALIZADO***\n2. SIEMPRE decide: conversaci√≥n O ***PRODUCTO_LISTO*** O ***CAMPO_ACTUALIZADO***\n3. Para MODO 3: SIEMPRE consulta primero con la herramienta antes de responder\n4. El JSON debe ser perfecto y completo seg√∫n el modo\n5. Usa informaci√≥n coherente y realista\n6. Mant√©n el estilo colombiano en descripciones\n7. Las palabras clave son SAGRADAS - √∫salas correctamente seg√∫n el modo\n8. TODOS los campos del JSON son obligatorios seg√∫n el modo\n9. Si ves \"GENERAR PRODUCTO AUTOM√ÅTICAMENTE\" en el mensaje, SIEMPRE genera el JSON completo\n10. NUNCA omitas ning√∫n campo de la estructura JSON seg√∫n el modo correspondiente\n11. SIEMPRE personaliza el contenido seg√∫n el producto espec√≠fico\n12. Para actualizaciones: SIEMPRE usa la herramienta consultar_productos PRIMERO\n\n\n\nEste es el ID siempre que el usuario quiera editar un producto {{ $('Webhook Conversacional').item.json.body.producto_actual.id }} {{ $('Webhook Conversacional').item.json.body.producto_actual.nombre }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [
        96,
        -48
      ],
      "id": "1479b4fa-3507-4a51-a1db-b5e0835ae4f1",
      "name": "Agente Maestro IA"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ [\n  {\n    \"tipo\": \"producto_generado\",\n    \"datos_producto\": $json.producto_generado || {},\n    \"json_limpio\": JSON.stringify($json.producto_generado || {}),\n    \"respuesta_agente\": \"¬°Producto generado autom√°ticamente! üéâ\",\n    \"id_sesion\": $json.id_sesion || 'default',\n    \"listo_para_generar\": true,\n    \"estado\": \"completado\",\n    \"mensaje\": \"¬°Producto creado exitosamente! üöÄ\",\n    \"auto_guardar\": true\n  }\n] }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1248,
        -64
      ],
      "id": "a0a3bdea-f0fc-4cec-b1d9-1233659fc685",
      "name": "Responder Producto"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "session-id",
              "name": "id_sesion",
              "value": "={{ $json.body?.conversacion_id || 'session_' + Date.now() }}",
              "type": "string"
            },
            {
              "id": "user-message",
              "name": "mensaje_usuario",
              "value": "={{ $json.body?.mensajes && Array.isArray($json.body.mensajes) && $json.body.mensajes.length > 0 ? $json.body.mensajes[$json.body.mensajes.length - 1]?.content || '' : $json.body?.mensaje || '' }}",
              "type": "string"
            },
            {
              "id": "all-messages",
              "name": "historial_completo",
              "value": "={{ JSON.stringify($json.body?.mensajes || []) }}",
              "type": "string"
            },
            {
              "id": "categorias",
              "name": "categorias_disponibles",
              "value": "={{ JSON.stringify($json.body?.categorias_disponibles || []) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -816,
        -64
      ],
      "id": "0a730055-a8c6-4084-81d9-d1e2ab409429",
      "name": "Extraer Datos"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "crear_productos_conversacional",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -992,
        -64
      ],
      "id": "200a42f0-100a-42fc-a7b4-bd13418fb82a",
      "name": "Webhook Conversacional",
      "webhookId": "crear-productos-conversacional"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.id_sesion || 'default_session' }}",
        "tableName": "chats_creador_productos",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -16,
        256
      ],
      "id": "ce1fb004-8842-4be2-acd0-c632e93c593a",
      "name": "Memoria del Chat",
      "credentials": {
        "postgres": {
          "id": "aGokiQ7IqpdnPcjx",
          "name": "Academia Joshua"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "producto-listo-check",
              "leftValue": "={{ $json.output }}",
              "rightValue": "***PRODUCTO_LISTO***",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        416,
        -48
      ],
      "id": "1e908026-74cc-4394-ad11-a1d2b8a710ec",
      "name": "¬øEs Producto Completo?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "campo-actualizado-check",
              "leftValue": "={{ $json.output }}",
              "rightValue": "***CAMPO_ACTUALIZADO***",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        656,
        160
      ],
      "id": "05687177-7809-4b42-9ff4-ed0279ac4cc2",
      "name": "¬øEs Campo Actualizado?"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ [\n  {\n    \"tipo\": \"conversacion\",\n    \"respuesta_agente\": $json.output || 'Respuesta del agente',\n    \"id_sesion\": $json.id_sesion || 'default',\n    \"listo_para_generar\": false,\n    \"estado\": \"conversando\",\n    \"mensaje\": $json.output || 'Continuando conversaci√≥n'\n  }\n] }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        832,
        352
      ],
      "id": "1b68bf08-b0d2-42fb-b174-5e190332800f",
      "name": "Responder Chat"
    },
    {
      "parameters": {
        "jsCode": "// Procesar JSON del producto completo\nconst output = $input.first().json.output;\n\n// Extraer el JSON despu√©s de ***PRODUCTO_LISTO***\nconst jsonStart = output.indexOf('***PRODUCTO_LISTO***') + '***PRODUCTO_LISTO***'.length;\nconst jsonString = output.substring(jsonStart).trim();\n\ntry {\n  const producto = JSON.parse(jsonString);\n  \n  return {\n    json: {\n      producto_generado: producto,\n      json_limpio: jsonString,\n      id_sesion: $input.first().json.id_sesion,\n      tipo_respuesta: 'producto_completo'\n    }\n  };\n} catch (error) {\n  return {\n    json: {\n      error: 'Error al procesar JSON del producto',\n      output_original: output,\n      id_sesion: $input.first().json.id_sesion,\n      tipo_respuesta: 'error'\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1056,
        -64
      ],
      "id": "13bbb828-b4f6-4768-86e5-1519257887b3",
      "name": "Procesar Producto JSON"
    },
    {
      "parameters": {
        "jsCode": "// Procesar JSON del campo actualizado\nconst output = $input.first().json.output;\n\n// Extraer el JSON despu√©s de ***CAMPO_ACTUALIZADO***\nconst jsonStart = output.indexOf('***CAMPO_ACTUALIZADO***') + '***CAMPO_ACTUALIZADO***'.length;\nconst jsonString = output.substring(jsonStart).trim();\n\ntry {\n  const campoActualizado = JSON.parse(jsonString);\n  \n  return {\n    json: {\n      campo_actualizado: campoActualizado,\n      json_limpio: jsonString,\n      id_sesion: $input.first().json.id_sesion,\n      tipo_respuesta: 'campo_actualizado'\n    }\n  };\n} catch (error) {\n  return {\n    json: {\n      error: 'Error al procesar JSON del campo actualizado',\n      output_original: output,\n      id_sesion: $input.first().json.id_sesion,\n      tipo_respuesta: 'error'\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1056,
        144
      ],
      "id": "ccb9ef0a-da75-44ed-953f-d733c23e4079",
      "name": "Procesar Campo JSON"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "actualizar-keyword",
              "leftValue": "={{ $json.mensaje_usuario }}",
              "rightValue": "actualizar|modificar|cambiar|mejorar|editar",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -624,
        -64
      ],
      "id": "e2d2baa7-9288-4198-84bc-350b0deec3bd",
      "name": "¬øDetectar Actualizaci√≥n?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "force-consultation",
              "name": "mensaje_usuario",
              "value": "={{ $json.mensaje_usuario + ' [CONSULTAR_PRIMERO_OBLIGATORIO]' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -272,
        -256
      ],
      "id": "1da25ddd-2e45-49b5-82a1-6ace75d6fbb3",
      "name": "Forzar Consulta Previa"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "productos",
        "limit": 1,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Conversacional').item.json.body.producto_id }}"
            },
            {
              "keyName": "activo",
              "condition": "eq",
              "keyValue": "true"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        272,
        272
      ],
      "id": "23214e62-df11-46f2-bc3c-55bfaa914aab",
      "name": "consultar_productos1",
      "credentials": {
        "supabaseApi": {
          "id": "W8gqsCw5s1YHm5SZ",
          "name": "Supabase Me LLEVO ESTO"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ [\n  {\n    \"tipo\": \"respuesta_con_opciones\",\n    \"campo_modificado\": $json.campo_actualizado?.campo_modificado || 'desconocido',\n    \"valor_anterior\": $json.campo_actualizado?.valor_anterior || '',\n    \"valor_nuevo\": $json.campo_actualizado?.valor_nuevo || '',\n    \"razon_cambio\": $json.campo_actualizado?.razon_cambio || '',\n    \"datos_actualizados\": $json.campo_actualizado?.datos_actualizados || {},\n    \"respuesta_agente\": \"¬°Campo actualizado exitosamente! ‚ú® ¬øQu√© te gustar√≠a hacer?\",\n    \"opciones\": [\n      {\n        \"tipo\": \"usar_producto\",\n        \"texto\": \"‚úÖ Usar este producto actualizado\",\n        \"icono\": \"‚úÖ\"\n      },\n      {\n        \"tipo\": \"reemplazar_campo\",\n        \"texto\": \"üîÑ Reemplazar solo este campo\",\n        \"campo\": $json.campo_actualizado?.campo_modificado || $json.campo_modificado || 'campo',\n        \"valor\": $json.campo_actualizado?.valor_nuevo || $json.valor_nuevo || '',\n        \"icono\": \"üîÑ\"\n      },\n      {\n        \"tipo\": \"continuar_conversacion\",\n        \"texto\": \"üí¨ Hacer m√°s cambios\",\n        \"mensaje\": \"Quiero seguir editando\",\n        \"icono\": \"üí¨\"\n      }\n    ],\n    \"producto_sugerido\": $json.campo_actualizado?.datos_actualizados || {},\n    \"id_sesion\": $json.id_sesion || 'default',\n    \"estado\": \"actualizado\",\n    \"mensaje\": \"¬°Actualizaci√≥n granular completada! üîÑ\"\n  }\n] }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1328,
        144
      ],
      "id": "b01ab1ac-a07b-4a51-85cb-02098517eb65",
      "name": "Responder Campo Actualizado1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -256,
        272
      ],
      "id": "f4634321-0fa0-4ee5-a679-c0751008395c",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "afEdUlo465aPlyDq",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    }
  ],
  "connections": {
    "Agente Maestro IA": {
      "main": [
        [
          {
            "node": "¬øEs Producto Completo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Datos": {
      "main": [
        [
          {
            "node": "¬øDetectar Actualizaci√≥n?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Conversacional": {
      "main": [
        [
          {
            "node": "Extraer Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria del Chat": {
      "ai_memory": [
        [
          {
            "node": "Agente Maestro IA",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs Producto Completo?": {
      "main": [
        [
          {
            "node": "Procesar Producto JSON",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¬øEs Campo Actualizado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs Campo Actualizado?": {
      "main": [
        [
          {
            "node": "Procesar Campo JSON",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Producto JSON": {
      "main": [
        [
          {
            "node": "Responder Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Campo JSON": {
      "main": [
        [
          {
            "node": "Responder Campo Actualizado1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øDetectar Actualizaci√≥n?": {
      "main": [
        [
          {
            "node": "Forzar Consulta Previa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agente Maestro IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Forzar Consulta Previa": {
      "main": [
        [
          {
            "node": "Agente Maestro IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "consultar_productos1": {
      "ai_tool": [
        [
          {
            "node": "Agente Maestro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Maestro IA",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "8000b702e0a3d9ac6d70099a2751603316de4028cd14af0949776a26efecb219"
  }
}