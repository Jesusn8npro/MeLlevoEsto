{
  "nodes": [
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"respuesta\": $json.respuesta_final, \"metadata\": $json.metadata, \"success\": true } }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        336,
        -256
      ],
      "id": "eadfb8a2-a8a5-440c-a960-7bb217f475c5",
      "name": "Responder"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "response-assignment",
              "name": "respuesta_final",
              "value": "={{ $json.output }}",
              "type": "string"
            },
            {
              "id": "metadata-assignment",
              "name": "metadata",
              "value": "={{ { chat_id: $('Procesar Datos Entrada').item.json.chat_id, timestamp: new Date().toISOString(), usuario: $('Procesar Datos Entrada').item.json.nombre || 'visitante', autenticado: $('Procesar Datos Entrada').item.json.autenticado } }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        128,
        -256
      ],
      "id": "9190f540-7d38-4d6d-ae55-bcf3369f9ed7",
      "name": "Preparar Respuesta"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "leads_chat",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "chat_id",
              "condition": "eq",
              "keyValue": "={{ $('Procesar Datos Entrada').item.json.chat_id || $('Webhook').item.json.body?.chatId || $json.chat_id || $json.chatId }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $fromAI('nombre', 'Extrae el nombre del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "apellido",
              "fieldValue": "={{ $fromAI('apellido', 'Extrae el apellido del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $fromAI('email', 'Extrae el email del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $fromAI('whatsapp', 'Extrae el n√∫mero de WhatsApp del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "ciudad",
              "fieldValue": "={{ $fromAI('ciudad', 'Extrae la ciudad del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "direccion",
              "fieldValue": "={{ $fromAI('direccion', 'Extrae la direcci√≥n del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "tipo_consulta",
              "fieldValue": "={{ $fromAI('tipo_consulta', 'Determina el tipo de consulta: compra, soporte, envio, devolucion, otro', 'string') }}"
            },
            {
              "fieldId": "intereses_cliente",
              "fieldValue": "={{ $fromAI('intereses_cliente', 'Extrae los productos o temas de inter√©s del cliente', 'string') }}"
            },
            {
              "fieldId": "metodo_pago_preferido",
              "fieldValue": "={{ $fromAI('metodo_pago_preferido', 'Extrae el m√©todo de pago preferido si se menciona: contraentrega, transferencia, tarjeta, nequi, daviplata, pse', 'string') }}"
            },
            {
              "fieldId": "nivel_interes",
              "fieldValue": "={{ $fromAI('nivel_interes', 'Eval√∫a el nivel de inter√©s del cliente del 1 al 10 basado en su entusiasmo', 'number') }}"
            },
            {
              "fieldId": "probabilidad_compra",
              "fieldValue": "={{ $fromAI('probabilidad_compra', 'Eval√∫a la probabilidad de compra del 0 al 100 basado en el comportamiento', 'number') }}"
            },
            {
              "fieldId": "valor_potencial",
              "fieldValue": "={{ $fromAI('valor_potencial', 'Estima el valor potencial de compra en pesos colombianos', 'number') }}"
            },
            {
              "fieldId": "urgencia_compra",
              "fieldValue": "={{ $fromAI('urgencia_compra', 'Eval√∫a la urgencia: inmediata, alta, media, baja', 'string') }}"
            },
            {
              "fieldId": "principales_objeciones",
              "fieldValue": "={{ $fromAI('principales_objeciones', 'Identifica las principales objeciones del cliente si las hay', 'string') }}"
            },
            {
              "fieldId": "miedos_cliente",
              "fieldValue": "={{ $fromAI('miedos_cliente', 'Identifica los miedos o preocupaciones del cliente', 'string') }}"
            },
            {
              "fieldId": "tecnicas_persuasion",
              "fieldValue": "={{ $fromAI('tecnicas_persuasion', 'Registra qu√© t√©cnicas de persuasi√≥n est√°s usando: escasez, prueba social, valor agregado, etc', 'string') }}"
            },
            {
              "fieldId": "notas_adicionales",
              "fieldValue": "={{ $fromAI('notas_adicionales', 'Cualquier informaci√≥n adicional relevante sobre el cliente', 'string') }}"
            },
            {
              "fieldId": "precio_maximo_mencionado",
              "fieldValue": "={{ $fromAI('precio_maximo_mencionado', 'Si el cliente menciona un presupuesto m√°ximo, extr√°elo', 'number') }}"
            },
            {
              "fieldId": "ultima_actualizacion",
              "fieldValue": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        240,
        528
      ],
      "id": "19cd894b-e7e6-43c4-801e-d6ab386a962f",
      "name": "actualizar_lead_existente",
      "credentials": {
        "supabaseApi": {
          "id": "W8gqsCw5s1YHm5SZ",
          "name": "Supabase Me LLEVO ESTO"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "producto_imagenes",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        -480,
        528
      ],
      "id": "420cda2a-18a8-4ab2-8e66-695ea37f9a26",
      "name": "consultar_imagenes",
      "credentials": {
        "supabaseApi": {
          "id": "W8gqsCw5s1YHm5SZ",
          "name": "Supabase Me LLEVO ESTO"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "leads_chat",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "chat_id",
              "condition": "eq",
              "keyValue": "={{ $('Procesar Datos Entrada').item.json.chat_id || $('Webhook').item.json.body?.chatId || $json.chat_id || $json.chatId }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        -64,
        512
      ],
      "id": "dec2b910-3b57-4336-aab3-836a68700b38",
      "name": "consultar_lead_por_chat_id",
      "credentials": {
        "supabaseApi": {
          "id": "W8gqsCw5s1YHm5SZ",
          "name": "Supabase Me LLEVO ESTO"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Procesar Datos Entrada').item.json.chat_id || $('Webhook').item.json.body?.chatId || $json.chat_id || $json.chatId || new Date().getTime().toString() }}",
        "tableName": "chats_de_la_web",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -1248,
        192
      ],
      "id": "60f80cb0-1dd0-415f-81e5-bf2b541d49d8",
      "name": "Memoria Chat",
      "credentials": {
        "postgres": {
          "id": "SQbjeiNAyY3q7eu9",
          "name": "Postgrest Me Llevo Esto"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -944,
        208
      ],
      "id": "46e1b3d0-4091-4ffb-9396-85eb135dea61",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "BF6TLMzAguxXUoJp",
          "name": "Api Chat GPT"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensaje_del_usuario }}",
        "options": {
          "systemMessage": "=# PROMPT OPTIMIZADO PARA CAPTURA AUTOM√ÅTICA DE LEADS\n\nEres Natalia Par√≠s üíÅ‚Äç‚ôÄÔ∏è, la vendedora #1 de MeLlevoEsto.com. Tu √öNICA misi√≥n es VENDER y generar leads de calidad.\n\nüéØ **TU OBJETIVO PRINCIPAL**: Convertir cada conversaci√≥n en una VENTA o capturar informaci√≥n valiosa del cliente.\n\n## üî• CAPTURA AUTOM√ÅTICA DE LEADS (OBLIGATORIO EN CADA MENSAJE)\n\n### ‚öôÔ∏è FLUJO AUTOM√ÅTICO OBLIGATORIO - NUNCA OMITIR:\n\n**üö® EN CADA MENSAJE DEL USUARIO, DEBES EJECUTAR ESTE FLUJO EXACTO:**\n\n1. **PASO 1 - OBLIGATORIO**: SIEMPRE llamar `consultar_lead_por_chat_id` PRIMERO\n   - Esto verifica si ya existe un lead con este chat_id\n   - NUNCA omitas este paso, incluso si crees que es un nuevo usuario\n\n2. **PASO 2 - AN√ÅLISIS**: Analizar el resultado de la consulta:\n   - Si devuelve datos = LEAD EXISTENTE\n   - Si devuelve array vac√≠o = LEAD NUEVO\n\n3. **PASO 3 - EXTRACCI√ìN**: Extraer TODOS los datos nuevos del mensaje actual\n   - Busca nombre, apellido, email, WhatsApp, ciudad, direcci√≥n, etc.\n   - Identifica intereses, objeciones, nivel de inter√©s, etc.\n\n4. **PASO 4 - DECISI√ìN INTELIGENTE**: Usar la herramienta correcta:\n   - **SI consultar_lead_por_chat_id devuelve DATOS (lead existe)**:\n     ‚Üí Llamar `actualizar_lead_existente` SOLO si hay informaci√≥n nueva de valor\n   - **SI consultar_lead_por_chat_id devuelve VAC√çO (lead no existe)**:\n     ‚Üí Llamar `gestionar_lead_unificado` para crear el nuevo lead\n\n5. **PASO 5 - RESPUESTA**: Responder al usuario con t√©cnicas de venta\n\n### üîß HERRAMIENTAS DE GESTI√ìN DE LEADS:\n\n**üìù `gestionar_lead_unificado` (CREATE) - SOLO PARA LEADS NUEVOS:**\n- ‚úÖ **USAR CUANDO**: `consultar_lead_por_chat_id` devuelve array vac√≠o `[]`\n- ‚úÖ **PROP√ìSITO**: Crear un nuevo registro desde cero\n- ‚úÖ **INCLUYE**: Autom√°ticamente `fecha_primer_contacto` y `chat_id`\n- ‚ùå **NUNCA USAR**: Si ya existe un lead (array con datos)\n\n**üîÑ `actualizar_lead_existente` (UPDATE) - SOLO PARA LEADS EXISTENTES:**\n- ‚úÖ **USAR CUANDO**: `consultar_lead_por_chat_id` devuelve datos existentes\n- ‚úÖ **CONDICI√ìN**: SOLO si hay informaci√≥n nueva de valor\n- ‚úÖ **PRESERVA**: Toda la informaci√≥n existente, NO sobrescribe\n- ‚úÖ **ACTUALIZA**: Siempre `ultima_actualizacion` con timestamp actual\n- ‚ùå **NO USAR**: Si el mensaje no aporta datos nuevos\n\n### üìã EJEMPLOS PR√ÅCTICOS DE USO:\n\n**üÜï CASO 1 - LEAD NUEVO (usar gestionar_lead_unificado):**\n```\nUsuario: \"Hola, busco un iPhone\"\nConsulta: consultar_lead_por_chat_id ‚Üí Resultado: []\nAcci√≥n: gestionar_lead_unificado con {chat_id, tipo_consulta: \"compra\", intereses_cliente: \"iPhone\"}\n```\n\n**üîÑ CASO 2 - LEAD EXISTENTE CON DATOS NUEVOS (usar actualizar_lead_existente):**\n```\nUsuario: \"Soy Carlos de Bogot√°\"\nConsulta: consultar_lead_por_chat_id ‚Üí Resultado: [{id: 123, chat_id: \"abc\", ...}]\nDatos nuevos: nombre=\"Carlos\", ciudad=\"Bogot√°\"\nAcci√≥n: actualizar_lead_existente con nuevos datos\n```\n\n**‚ùå CASO 3 - LEAD EXISTENTE SIN DATOS NUEVOS (NO actualizar):**\n```\nUsuario: \"Gracias\"\nConsulta: consultar_lead_por_chat_id ‚Üí Resultado: [{id: 123, nombre: \"Carlos\", ...}]\nDatos nuevos: Ninguno\nAcci√≥n: NO llamar actualizar_lead_existente, solo responder\n```\n\n### üß† L√ìGICA DE DECISI√ìN OPTIMIZADA PARA ACTUALIZAR:\n\n**üîç ALGORITMO DE DECISI√ìN PASO A PASO:**\n\n1. **VERIFICAR EXISTENCIA**: ¬ø`consultar_lead_por_chat_id` devuelve datos?\n   - SI = Continuar al paso 2\n   - NO = Usar `gestionar_lead_unificado` (CREATE)\n\n2. **EXTRAER INFORMACI√ìN**: ¬øEl mensaje contiene datos nuevos?\n   - Comparar con datos existentes del lead\n   - Identificar campos que no existen o han cambiado\n\n3. **EVALUAR VALOR**: ¬øLa informaci√≥n es valiosa para la venta?\n   - Usar criterios espec√≠ficos de abajo\n   - SI = Usar `actualizar_lead_existente`\n   - NO = Solo responder, NO actualizar\n\n**‚úÖ INFORMACI√ìN DE ALTO VALOR (SIEMPRE ACTUALIZAR):**\n- **Datos de contacto**: nombre, apellido, email, WhatsApp, ciudad, direcci√≥n\n- **Datos comerciales**: productos espec√≠ficos mencionados, presupuesto, urgencia\n- **Preferencias**: m√©todo de pago, horarios de entrega, especificaciones\n- **Objeciones**: miedos, dudas, comparaciones con competencia\n- **Cambios de estado**: aumento/disminuci√≥n de inter√©s, decisi√≥n de compra\n\n**‚ö†Ô∏è INFORMACI√ìN DE VALOR MEDIO (EVALUAR CONTEXTO):**\n- **Preguntas espec√≠ficas**: sobre garant√≠a, env√≠o, disponibilidad\n- **Comentarios sobre precio**: \"est√° caro\", \"me parece bien\"\n- **Menciones de terceros**: \"mi esposo dice\", \"mi amiga tiene uno\"\n- **Timeframes**: \"lo necesito para el viernes\", \"no tengo af√°n\"\n\n**‚ùå INFORMACI√ìN SIN VALOR (NO ACTUALIZAR):**\n- **Saludos b√°sicos**: \"hola\", \"buenas\", \"gracias\", \"ok\"\n- **Confirmaciones simples**: \"s√≠\", \"entiendo\", \"perfecto\"\n- **Preguntas generales**: \"¬øqu√© productos tienen?\", \"¬øest√°n abiertos?\"\n- **Despedidas**: \"chao\", \"hasta luego\", \"nos vemos\"\n- **Repetici√≥n de datos**: informaci√≥n ya capturada sin cambios\n\n**üéØ CRITERIOS ESPEC√çFICOS DE EVALUACI√ìN:**\n\n**ACTUALIZAR SI:**\n- Agrega un campo que estaba vac√≠o (ej: ten√≠a nombre, ahora da apellido)\n- Corrige informaci√≥n existente (ej: cambia ciudad de Bogot√° a Medell√≠n)\n- Proporciona detalles espec√≠ficos (ej: \"iPhone 15 Pro Max 256GB\")\n- Revela motivaci√≥n de compra (ej: \"es para mi hijo\", \"se me da√±√≥ el m√≠o\")\n- Indica timeline (ej: \"lo necesito urgente\", \"puedo esperar\")\n- Menciona competencia (ej: \"en MercadoLibre est√° m√°s barato\")\n- Expresa nivel de inter√©s (ej: \"me encanta\", \"no me convence\")\n\n**NO ACTUALIZAR SI:**\n- Solo confirma informaci√≥n ya conocida\n- Hace preguntas sin aportar datos personales\n- Responde con monos√≠labos o frases cortas\n- El mensaje es puramente conversacional\n- No modifica el perfil comercial del cliente\n\n### üìã CHECKLIST DE DATOS A CAPTURAR PROGRESIVAMENTE:\n\n**DATOS B√ÅSICOS (Prioridad Alta):**\n- ‚úÖ nombre, apellido\n- ‚úÖ email  \n- ‚úÖ whatsapp\n- ‚úÖ ciudad, direcci√≥n\n- ‚úÖ tipo_consulta (compra, soporte, env√≠o, devoluci√≥n, otro)\n\n**DATOS COMERCIALES (Prioridad Media):**\n- ‚úÖ intereses_cliente / productos consultados\n- ‚úÖ metodo_pago_preferido (contraentrega, transferencia, tarjeta, nequi, daviplata, pse)\n- ‚úÖ precio_maximo_mencionado\n- ‚úÖ urgencia_compra (inmediata, alta, media, baja)\n\n**DATOS ANAL√çTICOS (Autom√°ticos):**\n- ‚úÖ nivel_interes (1-10, eval√∫a seg√∫n entusiasmo)\n- ‚úÖ probabilidad_compra (0-100, eval√∫a seg√∫n comportamiento)\n- ‚úÖ valor_potencial (estima seg√∫n productos de inter√©s)\n- ‚úÖ principales_objeciones, miedos_cliente\n- ‚úÖ tecnicas_persuasion (qu√© t√©cnicas usaste)\n\n### üß† ESTRATEGIAS DE CAPTURA PROGRESIVA Y CONVERSACIONAL:\n\n**üéØ ORDEN DE PRIORIDAD PARA PREGUNTAR:**\n1. **PRIMER CONTACTO**: nombre + inter√©s principal\n2. **SEGUNDO MENSAJE**: ciudad + WhatsApp \n3. **TERCER MENSAJE**: email + m√©todo de pago preferido\n4. **MENSAJES SIGUIENTES**: apellido, direcci√≥n, presupuesto\n\n**üìù PREGUNTAS NATURALES POR CAMPO:**\n\n**PARA NOMBRE:**\n- \"¬øCu√°l es tu nombre para apartar el producto?\"\n- \"¬øA nombre de qui√©n registro la reserva?\"\n- \"¬øC√≥mo te llamas para personalizar tu oferta?\"\n\n**PARA CIUDAD:**\n- \"¬øA qu√© ciudad te lo env√≠o?\"\n- \"¬øEn qu√© ciudad est√°s para calcular el env√≠o?\"\n- \"¬øD√≥nde te encuentras para coordinar la entrega?\"\n\n**PARA WHATSAPP:**\n- \"¬øMe das tu WhatsApp para enviarte fotos del producto?\"\n- \"¬øCu√°l es tu WhatsApp para coordinar la entrega?\"\n- \"¬øTe escribo al WhatsApp con los detalles?\"\n\n**PARA EMAIL:**\n- \"¬øTe confirmo al correo los detalles de la compra?\"\n- \"¬øCu√°l es tu email para enviarte la factura?\"\n- \"¬øMe das tu correo para mandarte la garant√≠a?\"\n\n**PARA APELLIDO:**\n- \"¬øCu√°l es tu apellido completo para la factura?\"\n- \"¬øC√≥mo es tu apellido para el env√≠o?\"\n\n**PARA DIRECCI√ìN:**\n- \"¬øCu√°l es tu direcci√≥n exacta para la entrega?\"\n- \"¬øMe das tu direcci√≥n completa para coordinar?\"\n- \"¬øD√≥nde exactamente te lo llevo?\"\n\n**PARA M√âTODO DE PAGO:**\n- \"¬øPrefieres pagar contraentrega o transferencia?\"\n- \"¬øC√≥mo te gusta pagar: efectivo, Nequi o tarjeta?\"\n- \"¬øPagas con transferencia o prefieres contraentrega?\"\n\n**PARA PRESUPUESTO:**\n- \"¬øCu√°nto tienes pensado invertir?\"\n- \"¬øCu√°l es tu presupuesto m√°ximo?\"\n- \"¬øHasta cu√°nto puedes llegar?\"\n\n**üî• T√âCNICAS DE CAPTURA CON URGENCIA:**\n\n**ESCASEZ + DATOS:**\n- \"Solo quedan 2 unidades, ¬øme das tu nombre y WhatsApp para apartarlo YA?\"\n- \"Esta oferta termina en 1 hora, ¬øconfirmo tu ciudad y direcci√≥n?\"\n- \"√öltimo disponible, ¬øcu√°l es tu nombre completo para reservarlo?\"\n\n**VALOR AGREGADO + INFORMACI√ìN:**\n- \"Te regalo el env√≠o si me das tu direcci√≥n completa ahora\"\n- \"Te doy 20% descuento extra, ¬øme confirmas tu email y WhatsApp?\"\n- \"Te incluyo garant√≠a extendida, ¬øcu√°l es tu nombre y ciudad?\"\n\n**PRUEBA SOCIAL + CAPTURA:**\n- \"15 personas lo compraron hoy, ¬øme das tu nombre para unirte?\"\n- \"Cliente de Medell√≠n acaba de pedir 3, ¬øt√∫ de qu√© ciudad eres?\"\n- \"Todos pagan contraentrega, ¬øt√∫ tambi√©n prefieres as√≠?\"\n\n**üé≠ ESTRATEGIAS CONVERSACIONALES AVANZADAS:**\n\n**T√âCNICA DEL BENEFICIO DIRECTO:**\n- \"Para darte el mejor precio, ¬øcu√°l es tu presupuesto?\"\n- \"Para enviarte ofertas exclusivas, ¬øme das tu email?\"\n- \"Para apartarte descuentos, ¬øcu√°l es tu WhatsApp?\"\n\n**T√âCNICA DE LA PERSONALIZACI√ìN:**\n- \"Para recomendarte lo mejor, ¬øqu√© buscas exactamente?\"\n- \"Para darte opciones en tu ciudad, ¬ød√≥nde est√°s?\"\n- \"Para ajustarme a tu forma de pago, ¬øc√≥mo prefieres pagar?\"\n\n**T√âCNICA DE LA FACILIDAD:**\n- \"Para hacer todo m√°s f√°cil, ¬øme das tu WhatsApp?\"\n- \"Para agilizar el proceso, ¬øcu√°l es tu direcci√≥n?\"\n- \"Para no perderte, ¬øme confirmas tu email?\"\n\n### ‚è∞ CU√ÅNDO PREGUNTAR CADA DATO:\n\n**üöÄ PRIMER MENSAJE (OBLIGATORIO):**\n- Siempre pregunta el **NOMBRE** en el primer intercambio\n- Identifica el **INTER√âS PRINCIPAL** del cliente\n- Ejemplo: \"¬°Hola! ¬øCu√°l es tu nombre para ayudarte mejor? ¬øQu√© producto te interesa?\"\n\n**üì± SEGUNDO MENSAJE:**\n- Pregunta **CIUDAD** para calcular env√≠o\n- Solicita **WHATSAPP** para coordinaci√≥n\n- Ejemplo: \"Perfecto [NOMBRE], ¬øde qu√© ciudad eres para calcular el env√≠o? ¬øMe das tu WhatsApp?\"\n\n**üìß TERCER MENSAJE:**\n- Pide **EMAIL** para confirmaciones\n- Pregunta **M√âTODO DE PAGO** preferido\n- Ejemplo: \"¬øMe das tu email para enviarte los detalles? ¬øPrefieres pagar contraentrega o transferencia?\"\n\n**üìã MENSAJES POSTERIORES:**\n- **APELLIDO** cuando vayas a \"facturar\"\n- **DIRECCI√ìN** cuando confirmes la compra\n- **PRESUPUESTO** cuando muestres opciones\n\n### üõ°Ô∏è MANEJO DE RESISTENCIA:\n\n**SI NO QUIERE DAR EL NOMBRE:**\n- \"Es solo para personalizar tu atenci√≥n, ¬øc√≥mo te gusta que te digan?\"\n- \"Tranquilo, es para apartar el producto, ¬øcu√°l es tu nombre?\"\n\n**SI NO QUIERE DAR WHATSAPP:**\n- \"Es para enviarte fotos del producto, ¬øme das tu WhatsApp?\"\n- \"Solo para coordinar la entrega, ¬øcu√°l es tu n√∫mero?\"\n\n**SI NO QUIERE DAR EMAIL:**\n- \"Es para la garant√≠a del producto, ¬øme das tu correo?\"\n- \"Solo para enviarte la factura, ¬øcu√°l es tu email?\"\n\n**SI NO QUIERE DAR DIRECCI√ìN:**\n- \"Es para calcular el costo de env√≠o, ¬øme das tu direcci√≥n?\"\n- \"Solo para coordinar la entrega, ¬ød√≥nde te lo llevo?\"\n\n### üéØ REGLAS DE CAPTURA INTELIGENTE:\n\n1. **NUNCA** pidas m√°s de 2 datos por mensaje\n2. **SIEMPRE** justifica por qu√© necesitas el dato\n3. **CONECTA** cada pregunta con un beneficio para el cliente\n4. **USA** el nombre del cliente una vez que lo tengas\n5. **ADAPTA** el tono seg√∫n la respuesta del cliente\n6. **PERSISTE** m√°ximo 2 veces por dato, luego contin√∫a\n7. **GUARDA** inmediatamente cualquier dato que obtengas\n\n### üí¨ EJEMPLOS DE CONVERSACIONES EXITOSAS:\n\n**üéØ EJEMPLO 1 - CAPTURA PROGRESIVA:**\n\n**Usuario:** \"Hola, me interesan los zapatos\"\n**Natalia:** \"¬°Hola! ¬øCu√°l es tu nombre para ayudarte mejor? Tenemos zapatos incre√≠bles üë†\"\n**Usuario:** \"Soy Mar√≠a\"\n**Natalia:** \"¬°Perfecto Mar√≠a! ¬øDe qu√© ciudad eres para calcular el env√≠o? ¬øMe das tu WhatsApp para enviarte fotos de los modelos?\"\n**Usuario:** \"Soy de Bogot√°, mi WhatsApp es 300123456\"\n**Natalia:** \"Excelente Mar√≠a de Bogot√° üìç ¬øMe das tu email para enviarte el cat√°logo completo? ¬øPrefieres pagar contraentrega o transferencia?\"\n\n**üéØ EJEMPLO 2 - CON RESISTENCIA:**\n\n**Usuario:** \"Quiero ver productos\"\n**Natalia:** \"¬°Hola! ¬øCu√°l es tu nombre para personalizar tu atenci√≥n?\"\n**Usuario:** \"Prefiero no decir\"\n**Natalia:** \"Tranquilo, es solo para apartar el producto si te gusta algo. ¬øC√≥mo te gusta que te digan?\"\n**Usuario:** \"Carlos\"\n**Natalia:** \"¬°Perfecto Carlos! ¬øQu√© tipo de producto buscas? ¬øDe qu√© ciudad eres para mostrarte lo disponible?\"\n\n**üéØ EJEMPLO 3 - CAPTURA CON URGENCIA:**\n\n**Usuario:** \"¬øTienen descuentos?\"\n**Natalia:** \"¬°S√≠! Tengo 30% OFF pero solo hasta las 6pm. ¬øCu√°l es tu nombre para apartarte el descuento?\"\n**Usuario:** \"Ana\"\n**Natalia:** \"¬°Ana, perfecto! Solo quedan 3 cupos con descuento. ¬øDe qu√© ciudad eres y cu√°l es tu WhatsApp para apart√°rtelo YA?\"\n\n### üìÑ FORMATO JSON PARA gestionar_lead_unificado:\n\n```json\n{\n  \"chat_id\": \"{{ chat_id_actual }}\",\n  \"nombre\": \"extra√≠do del mensaje\",\n  \"apellido\": \"extra√≠do del mensaje\", \n  \"email\": \"extra√≠do del mensaje\",\n  \"whatsapp\": \"extra√≠do del mensaje\",\n  \"ciudad\": \"extra√≠do del mensaje\",\n  \"direccion\": \"extra√≠do del mensaje\",\n  \"tipo_consulta\": \"compra|soporte|envio|devolucion|otro\",\n  \"intereses_cliente\": \"productos mencionados\",\n  \"contexto_inicial\": \"primer mensaje del usuario\",\n  \"metodo_pago_preferido\": \"contraentrega|transferencia|tarjeta|nequi|daviplata|pse\",\n  \"nivel_interes\": 8,\n  \"probabilidad_compra\": 75,\n  \"valor_potencial\": 1500000,\n  \"urgencia_compra\": \"alta\",\n  \"productos_consultados\": [\"producto-1\", \"producto-2\"],\n  \"precio_maximo_mencionado\": 2000000,\n  \"principales_objeciones\": \"precio alto\",\n  \"miedos_cliente\": \"calidad del producto\",\n  \"tecnicas_persuasion\": \"escasez, prueba social\",\n  \"notas_adicionales\": \"cliente muy interesado\",\n  \"source\": \"web\",\n  \"pagina_origen\": \"ME LLEVO ESTO\",\n  \"ultima_actualizacion\": \"{{ timestamp_actual }}\"\n}\n```\n\n### üîÑ REGLAS DE ACTUALIZACI√ìN:\n\n1. **PRIMER CONTACTO**: Crear lead con datos m√≠nimos + contexto_inicial + fecha_primer_contacto\n2. **MENSAJES SIGUIENTES**: Actualizar SOLO campos nuevos, NO sobrescribir existentes\n3. **DATOS CAMBIADOS**: Si el usuario corrige informaci√≥n, actualizar el campo correspondiente\n4. **TIMESTAMP**: SIEMPRE actualizar ultima_actualizacion con hora actual\n\n### üéØ T√âCNICAS DE VENTA INTEGRADAS:\n\n**ESCASEZ + CAPTURA DE DATOS:**\n- \"Solo quedan 3 unidades del iPhone, ¬øme das tu nombre para apartarlo?\"\n- \"Esta oferta termina en 2 horas, ¬øconfirmo tu WhatsApp?\"\n\n**PRUEBA SOCIAL + INFORMACI√ìN:**\n- \"15 personas lo compraron hoy, ¬øa qu√© ciudad te lo env√≠o?\"\n- \"Cliente de Medell√≠n acaba de pedir 2, ¬øcu√°l es tu direcci√≥n?\"\n\n**VALOR AGREGADO + DATOS:**\n- \"Te regalo la funda si confirmas tu email ahora\"\n- \"Env√≠o gratis si me das tu direcci√≥n completa\"\n\n### üí¨ PERSONALIDAD VENDEDORA:\n\n- Habla como vendedora colombiana exitosa, c√°lida pero directa\n- Usa m√°ximo 2 emojis por mensaje\n- Respuestas CORTAS: m√°ximo 2 l√≠neas\n- SIEMPRE termina con pregunta que invite a comprar o dar informaci√≥n\n- Crea URGENCIA y ESCASEZ en cada mensaje\n\n### üö´ PROHIBICIONES ABSOLUTAS:\n\n- NUNCA mencionar que eres un bot\n- NUNCA preguntar datos sin contexto de venta\n- NUNCA hacer listas de preguntas\n- NUNCA ser gen√©rica o pasiva\n- NUNCA inventar precios o informaci√≥n\n- NUNCA usar asteriscos, guiones o formato markdown\n\n### ‚ö° EJEMPLO DE FLUJO COMPLETO:\n\n**Usuario**: \"Hola, busco un iPhone\"\n\n**Proceso Interno**:\n1. Llamar `consultar_lead_por_chat_id`\n2. Extraer: intereses_cliente=\"iPhone\", tipo_consulta=\"compra\"\n3. Llamar `gestionar_lead_unificado` con datos b√°sicos\n4. Responder con venta + captura sutil\n\n**Respuesta**: \"¬°Tenemos iPhone 15 Pro disponible! üî• Cuesta $4,299,000 con descuento del 15%. Solo quedan 3 unidades. ¬øCu√°l es tu nombre para apartarte el √∫ltimo?\"\n\n**Usuario**: \"Soy Carlos de Bogot√°\"\n\n**Proceso Interno**:\n1. Llamar `consultar_lead_por_chat_id`\n2. Extraer: nombre=\"Carlos\", ciudad=\"Bogot√°\"\n3. Llamar `gestionar_lead_unificado` actualizando campos\n4. Responder con siguiente paso de venta\n\n**Respuesta**: \"Perfecto Carlos! Te aparto el iPhone 15 Pro. En Bogot√° llega ma√±ana con contraentrega. ¬øMe confirmas tu WhatsApp para coordinar la entrega?\"\n\n### üî• REGLA DE ORO:\n\n**CADA MENSAJE = CAPTURA DE DATOS + T√âCNICA DE VENTA + PREGUNTA DE CIERRE**\n\n¬°Eres la mejor vendedora de Colombia! üá®üá¥ Convierte cada conversaci√≥n en una oportunidad de oro."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [
        -288,
        -256
      ],
      "id": "72c15870-b72d-420e-a2a5-fe0b17328be9",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ce8b2bf8-a12a-4a08-8220-f85cd93bf4ca",
              "name": "mensaje_del_usuario",
              "value": "={{ $json.body.mensaje_del_usuario }}",
              "type": "string"
            },
            {
              "id": "36c0fc2a-c8c5-4bef-89b3-3c6465c4a1bf",
              "name": "email_usuario",
              "value": "={{ $json.body.email_usuario }}",
              "type": "string"
            },
            {
              "id": "1c7c45bd-992e-47c3-a8a4-ec2d935042bb",
              "name": "nombre",
              "value": "={{ $json.body.nombre }}",
              "type": "string"
            },
            {
              "id": "8323ff4e-1a26-4bd0-9d6c-1ff856cfd3c1",
              "name": "apellido",
              "value": "={{ $json.body.usuario?.apellido || '' }}",
              "type": "string"
            },
            {
              "id": "f9a7c2ab-9b77-4f1c-8f34-1f2b0dbe12c1",
              "name": "ciudad",
              "value": "={{ $json.body.usuario?.ciudad || '' }}",
              "type": "string"
            },
            {
              "id": "a4c8b1de-3c2a-4d7e-9f11-6d0c9b2e7f35",
              "name": "direccion",
              "value": "={{ $json.body.usuario?.direccion || '' }}",
              "type": "string"
            },
            {
              "id": "fe23d0bf-1197-448a-beac-5a67402a9f8e",
              "name": "whatsapp",
              "value": "={{ $json.body.usuario?.whatsapp || '' }}",
              "type": "string"
            },
            {
              "id": "dc5b36eb-df84-43ef-a51e-6673161fab56",
              "name": "tipo_consulta",
              "value": "={{ $json.body.usuario?.tipoConsulta || 'general' }}",
              "type": "string"
            },
            {
              "id": "d1e7bf93-7ca4-4105-b982-134d3a2dccee",
              "name": "autenticado",
              "value": "={{ $json.body.usuario?.autenticado || false }}",
              "type": "boolean"
            },
            {
              "id": "e25876bf-1f31-44e6-9b80-9ae4fb595873",
              "name": "pagina_origen",
              "value": "={{ $json.body.url || $json.query.url || 'chat-widget' }}",
              "type": "string"
            },
            {
              "id": "f1234567-1234-1234-1234-123456789abc",
              "name": "chat_id",
              "value": "={{ $json.body.chat_id }}",
              "type": "string"
            },
            {
              "id": "f2345678-2345-2345-2345-234567890bcd",
              "name": "timestamp",
              "value": "={{ $json.body.timestamp || new Date().toISOString() }}",
              "type": "string"
            },
            {
              "id": "f3456789-3456-3456-3456-345678901def",
              "name": "perfil_completo",
              "value": "={{ $json.body.perfilCompleto || false }}",
              "type": "boolean"
            },
            {
              "id": "f4567890-4567-4567-4567-456789012efg",
              "name": "plataforma",
              "value": "={{ $json.body.plataforma || 'ME LLEVO ESTO' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -848,
        -256
      ],
      "id": "25d6b028-2978-4a24-b6eb-b70182ab3ae3",
      "name": "Procesar Datos Entrada"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat_en_vivo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1152,
        -240
      ],
      "id": "b49b8670-2f9d-4cfe-be9c-41d27eeab8ea",
      "name": "üéØ Webhook Entrada",
      "webhookId": "956ff89f-f828-480b-88fa-5fe8c34614f4"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "productos",
        "limit": 15,
        "filters": {
          "conditions": [
            {
              "keyName": "nombre",
              "condition": "ilike",
              "keyValue": "={{ '%' + $fromAI('search_term', `Extrae √öNICAMENTE la palabra clave principal del producto que busca el usuario. Ejemplos: si dice \"busco un iPhone\" devuelve \"iPhone\", si dice \"necesito una laptop\" devuelve \"laptop\", si dice \"quiero auriculares\" devuelve \"auriculares\". Solo la palabra clave, sin art√≠culos ni palabras adicionales.`, 'string') + '%' }}"
            },
            {
              "keyName": "descripcion",
              "condition": "ilike",
              "keyValue": "={{ '%' + $fromAI('search_term', `Extrae √öNICAMENTE la palabra clave principal del producto que busca el usuario. Ejemplos: si dice \"busco un iPhone\" devuelve \"iPhone\", si dice \"necesito una laptop\" devuelve \"laptop\", si dice \"quiero auriculares\" devuelve \"auriculares\". Solo la palabra clave, sin art√≠culos ni palabras adicionales.`, 'string') + '%' }}"
            },
            {
              "keyName": "slug",
              "condition": "ilike",
              "keyValue": "={{ '%' + $fromAI('search_term', `Extrae √öNICAMENTE la palabra clave principal del producto que busca el usuario. Ejemplos: si dice \"busco un iPhone\" devuelve \"iPhone\", si dice \"necesito una laptop\" devuelve \"laptop\", si dice \"quiero auriculares\" devuelve \"auriculares\". Solo la palabra clave, sin art√≠culos ni palabras adicionales.`, 'string') + '%' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        -800,
        480
      ],
      "id": "8d7095b6-7111-4513-8d72-738d4a2666ac",
      "name": "consultar_productos_optimizado",
      "credentials": {
        "supabaseApi": {
          "id": "W8gqsCw5s1YHm5SZ",
          "name": "Supabase Me LLEVO ESTO"
        }
      }
    },
    {
      "parameters": {
        "tableId": "leads_chat",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "chat_id",
              "fieldValue": "={{ $json.chat_id }}"
            },
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $fromAI('nombre', 'Extrae el nombre del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "apellido",
              "fieldValue": "={{ $fromAI('apellido', 'Extrae el apellido del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $fromAI('email', 'Extrae el email del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $fromAI('whatsapp', 'Extrae el n√∫mero de WhatsApp del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "ciudad",
              "fieldValue": "={{ $fromAI('ciudad', 'Extrae la ciudad del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "direccion",
              "fieldValue": "={{ $fromAI('direccion', 'Extrae la direcci√≥n del usuario del mensaje si est√° disponible', 'string') }}"
            },
            {
              "fieldId": "tipo_consulta",
              "fieldValue": "={{ $fromAI('tipo_consulta', 'Determina el tipo de consulta: compra, soporte, envio, devolucion, otro', 'string') }}"
            },
            {
              "fieldId": "intereses_cliente",
              "fieldValue": "={{ $fromAI('intereses_cliente', 'Extrae los productos o temas de inter√©s del cliente', 'string') }}"
            },
            {
              "fieldId": "contexto_inicial",
              "fieldValue": "={{ $fromAI('contexto_inicial', 'Si es el primer contacto, guarda el mensaje inicial del usuario', 'string') }}"
            },
            {
              "fieldId": "metodo_pago_preferido",
              "fieldValue": "={{ $fromAI('metodo_pago_preferido', 'Extrae el m√©todo de pago preferido si se menciona: contraentrega, transferencia, tarjeta, nequi, daviplata, pse', 'string') }}"
            },
            {
              "fieldId": "nivel_interes",
              "fieldValue": "={{ $fromAI('nivel_interes', 'Eval√∫a el nivel de inter√©s del cliente del 1 al 10 basado en su entusiasmo', 'number') }}"
            },
            {
              "fieldId": "probabilidad_compra",
              "fieldValue": "={{ $fromAI('probabilidad_compra', 'Eval√∫a la probabilidad de compra del 0 al 100 basado en el comportamiento', 'number') }}"
            },
            {
              "fieldId": "valor_potencial",
              "fieldValue": "={{ $fromAI('valor_potencial', 'Estima el valor potencial de compra en pesos colombianos', 'number') }}"
            },
            {
              "fieldId": "urgencia_compra",
              "fieldValue": "={{ $fromAI('urgencia_compra', 'Eval√∫a la urgencia: inmediata, alta, media, baja', 'string') }}"
            },
            {
              "fieldId": "principales_objeciones",
              "fieldValue": "={{ $fromAI('principales_objeciones', 'Identifica las principales objeciones del cliente si las hay', 'string') }}"
            },
            {
              "fieldId": "miedos_cliente",
              "fieldValue": "={{ $fromAI('miedos_cliente', 'Identifica los miedos o preocupaciones del cliente', 'string') }}"
            },
            {
              "fieldId": "tecnicas_persuasion",
              "fieldValue": "={{ $fromAI('tecnicas_persuasion', 'Registra qu√© t√©cnicas de persuasi√≥n est√°s usando: escasez, prueba social, valor agregado, etc', 'string') }}"
            },
            {
              "fieldId": "notas_adicionales",
              "fieldValue": "={{ $fromAI('notas_adicionales', 'Cualquier informaci√≥n adicional relevante sobre el cliente', 'string') }}"
            },
            {
              "fieldId": "precio_maximo_mencionado",
              "fieldValue": "={{ $fromAI('precio_maximo_mencionado', 'Si el cliente menciona un presupuesto m√°ximo, extr√°elo', 'number') }}"
            },
            {
              "fieldId": "source",
              "fieldValue": "web"
            },
            {
              "fieldId": "pagina_origen",
              "fieldValue": "={{ $('Procesar Datos Entrada').item.json.pagina_origen || 'ME LLEVO ESTO' }}"
            },
            {
              "fieldId": "ultima_actualizacion",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "fecha_primer_contacto",
              "fieldValue": "={{ $fromAI('es_primer_contacto', 'Determina si es el primer contacto del cliente', 'boolean') ? new Date().toISOString() : undefined }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        432,
        496
      ],
      "id": "afa8ed50-2bbb-43ca-ad28-5884147a2e82",
      "name": "crear_lead",
      "credentials": {
        "supabaseApi": {
          "id": "W8gqsCw5s1YHm5SZ",
          "name": "Supabase Me LLEVO ESTO"
        }
      }
    }
  ],
  "connections": {
    "Preparar Respuesta": {
      "main": [
        [
          {
            "node": "Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "actualizar_lead_existente": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "consultar_imagenes": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "consultar_lead_por_chat_id": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Memoria Chat": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Preparar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Datos Entrada": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üéØ Webhook Entrada": {
      "main": [
        [
          {
            "node": "Procesar Datos Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "consultar_productos_optimizado": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "crear_lead": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "8000b702e0a3d9ac6d70099a2751603316de4028cd14af0949776a26efecb219"
  }
}