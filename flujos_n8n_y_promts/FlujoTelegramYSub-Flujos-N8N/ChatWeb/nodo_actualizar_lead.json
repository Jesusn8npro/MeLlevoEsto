{
  "nodes": [
    {
      "parameters": {
        "operation": "update",
        "tableId": "leads_chat",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "chat_id",
              "condition": "eq",
              "keyValue": "={{ $('Procesar Datos Entrada').item.json.chat_id || $('Webhook').item.json.body?.chatId || $json.chat_id || $json.chatId }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $fromAI('nombre', 'Extrae el nombre del usuario del mensaje si está disponible', 'string') || null }}"
            },
            {
              "fieldId": "apellido",
              "fieldValue": "={{ $fromAI('apellido', 'Extrae el apellido del usuario del mensaje si está disponible', 'string') || null }}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $fromAI('email', 'Extrae el email del usuario del mensaje si está disponible', 'string') || null }}"
            },
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $fromAI('whatsapp', 'Extrae el número de WhatsApp del usuario del mensaje si está disponible', 'string') || null }}"
            },
            {
              "fieldId": "ciudad",
              "fieldValue": "={{ $fromAI('ciudad', 'Extrae la ciudad del usuario del mensaje si está disponible', 'string') || null }}"
            },
            {
              "fieldId": "direccion",
              "fieldValue": "={{ $fromAI('direccion', 'Extrae la dirección del usuario del mensaje si está disponible', 'string') || null }}"
            },
            {
              "fieldId": "datos_envio",
              "fieldValue": "={{ $fromAI('datos_envio', 'Extrae información de envío como preferencias de horario, instrucciones especiales, etc. en formato JSON', 'string') || null }}"
            },
            {
              "fieldId": "tipo_consulta",
              "fieldValue": "={{ $fromAI('tipo_consulta', 'Determina el tipo de consulta: compra, soporte, envio, devolucion, otro', 'string') || 'otro' }}"
            },
            {
              "fieldId": "metodo_pago_preferido",
              "fieldValue": "={{ $fromAI('metodo_pago_preferido', 'Extrae el método de pago preferido si se menciona: contraentrega, transferencia, tarjeta, nequi, daviplata, pse', 'string') || null }}"
            },
            {
              "fieldId": "precio_maximo_mencionado",
              "fieldValue": "={{ $fromAI('precio_maximo_mencionado', 'Si el cliente menciona un presupuesto máximo, extráelo como número', 'number') || null }}"
            },
            {
              "fieldId": "urgencia_compra",
              "fieldValue": "={{ $fromAI('urgencia_compra', 'Evalúa la urgencia: inmediata, alta, media, baja', 'string') || 'media' }}"
            },
            {
              "fieldId": "nivel_interes",
              "fieldValue": "={{ $fromAI('nivel_interes', 'Evalúa el nivel de interés del cliente del 1 al 10 basado en su entusiasmo', 'number') || 5 }}"
            },
            {
              "fieldId": "probabilidad_compra",
              "fieldValue": "={{ $fromAI('probabilidad_compra', 'Evalúa la probabilidad de compra del 0 al 100 basado en el comportamiento', 'number') || 50 }}"
            },
            {
              "fieldId": "valor_potencial",
              "fieldValue": "={{ $fromAI('valor_potencial', 'Estima el valor potencial de compra en pesos colombianos', 'number') || null }}"
            },
            {
              "fieldId": "principales_objeciones",
              "fieldValue": "={{ $fromAI('principales_objeciones', 'Identifica las principales objeciones del cliente si las hay', 'string') || null }}"
            },
            {
              "fieldId": "miedos_cliente",
              "fieldValue": "={{ $fromAI('miedos_cliente', 'Identifica los miedos o preocupaciones del cliente', 'string') || null }}"
            },
            {
              "fieldId": "tecnicas_persuasion",
              "fieldValue": "={{ $fromAI('tecnicas_persuasion', 'Registra qué técnicas de persuasión estás usando: escasez, prueba social, valor agregado, etc', 'string') || null }}"
            },
            {
              "fieldId": "estado",
              "fieldValue": "={{ $fromAI('estado', 'Evalúa el estado del lead: activo, inactivo, convertido, perdido', 'string') || 'activo' }}"
            },
            {
              "fieldId": "converted",
              "fieldValue": "={{ $fromAI('converted', 'Determina si el lead se ha convertido en venta: true o false', 'boolean') || false }}"
            },
            {
              "fieldId": "contexto_inicial",
              "fieldValue": "={{ $fromAI('contexto_inicial', 'Si es relevante, actualiza el contexto inicial del usuario', 'string') || null }}"
            },
            {
              "fieldId": "productos_consultados",
              "fieldValue": "={{ $fromAI('productos_consultados', 'Lista de productos consultados separados por comas', 'string') ? $fromAI('productos_consultados', 'Lista de productos consultados separados por comas', 'string').split(',').map(p => p.trim()).filter(p => p) : null }}"
            },
            {
              "fieldId": "notas_adicionales",
              "fieldValue": "={{ $fromAI('notas_adicionales', 'Cualquier información adicional relevante sobre el cliente', 'string') || null }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        272,
        720
      ],
      "id": "59c1589c-2aab-4508-a025-afb7b481c917",
      "name": "actualizar_lead_existente",
      "credentials": {
        "supabaseApi": {
          "id": "W8gqsCw5s1YHm5SZ",
          "name": "Supabase Me LLEVO ESTO"
        }
      }
    }
  ],
  "connections": {
    "actualizar_lead_existente": {
      "ai_tool": [
        []
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "8000b702e0a3d9ac6d70099a2751603316de4028cd14af0949776a26efecb219"
  }
}