{
  "nodes": [
    {
      "parameters": {
        "jsCode": "// ðŸ”„ PROCESADOR DE JSON DE PRODUCTO (normaliza objetos y categorÃ­a)\nconsole.log('ðŸ”„ PROCESANDO PRODUCTO JSON');\n\nconst entrada = $input.first();\nconst producto = entrada.json.producto_objeto;\n\nconsole.log('ðŸ“¥ Producto recibido:', producto?.nombre);\nconsole.log('ðŸ“Š Campos disponibles:', producto ? Object.keys(producto) : []);\n\nfunction parseObjeto(val) {\n  try {\n    if (!val) return null;\n    if (typeof val === 'string') {\n      const p = JSON.parse(val);\n      return (p && typeof p === 'object') ? p : null;\n    }\n    if (typeof val === 'object') return val;\n    return null;\n  } catch {\n    return null;\n  }\n}\n\n// ðŸ”¥ PROCESAR CATEGORÃA\nlet categoriaId = null;\nlet categoriaNombre = 'General';\n\nif (producto.categoria) {\n  if (typeof producto.categoria === 'object' && producto.categoria.id) {\n    categoriaId = producto.categoria.id;\n    categoriaNombre = producto.categoria.nombre;\n  } else if (typeof producto.categoria === 'string') {\n    // Buscar categorÃ­a por nombre\n    const categorias = entrada.json.categorias || [];\n    const catEncontrada = categorias.find(cat => \n      cat.nombre.toLowerCase().includes(producto.categoria.toLowerCase())\n    );\n    if (catEncontrada) {\n      categoriaId = catEncontrada.id;\n      categoriaNombre = catEncontrada.nombre;\n    }\n  }\n}\n\n// ðŸ”¥ PROCESAR IMÃGENES\nlet imagenesProcesadas = { principal: null, galeria: [], imagen_caracteristicas: null };\nif (producto.imagenes) {\n  if (typeof producto.imagenes === 'object') {\n    imagenesProcesadas.principal = producto.imagenes.principal || null;\n    imagenesProcesadas.galeria = Array.isArray(producto.imagenes.galeria) ? producto.imagenes.galeria.slice(0, 5) : [];\n    imagenesProcesadas.imagen_caracteristicas = producto.imagenes.imagen_caracteristicas || null;\n  } else if (typeof producto.imagenes === 'string') {\n    imagenesProcesadas.principal = producto.imagenes;\n  }\n}\n\n// ðŸ”¥ PROCESAR PRECIOS\nlet precio = 0; let precioOriginal = 0; let descuento = 0;\nif (producto.precio) {\n  if (typeof producto.precio === 'string') precio = parseInt(producto.precio.replace(/[^0-9]/g, '')) || 0;\n  else if (typeof producto.precio === 'number') precio = producto.precio;\n}\nif (producto.precio_original) {\n  if (typeof producto.precio_original === 'string') precioOriginal = parseInt(producto.precio_original.replace(/[^0-9]/g, '')) || 0;\n  else if (typeof producto.precio_original === 'number') precioOriginal = producto.precio_original;\n}\nif (precioOriginal > 0 && precio < precioOriginal) { descuento = Math.round(((precioOriginal - precio) / precioOriginal) * 100); }\n\n// ðŸ”¥ PROCESAR ESPECIFICACIONES\nlet especificacionesProcesadas = { marca: 'No especificada', modelo: 'No especificado', material: 'No especificado', color: 'No especificado', talla: 'No especificado', peso: 'No especificado', garantia_meses: 0, origen_pais: 'No especificado', dimensiones: 'No especificado' };\nif (producto.especificaciones) {\n  if (typeof producto.especificaciones === 'object') Object.assign(especificacionesProcesadas, producto.especificaciones);\n  else if (typeof producto.especificaciones === 'string') {\n    try { const especs = JSON.parse(producto.especificaciones); Object.assign(especificacionesProcesadas, especs); } catch { console.log('âš ï¸ No se pudo parsear especificaciones string'); }\n  }\n}\n\n// ðŸ”¥ CREAR PRODUCTO PROCESADO\nconst productoProcesado = {\n  nombre: producto.nombre || 'Producto sin nombre',\n  slug: producto.nombre ? producto.nombre.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') : 'producto-sin-nombre',\n  descripcion: producto.descripcion || 'Sin descripciÃ³n',\n  ganchos: producto.ganchos || null,\n  precio, precio_original: precioOriginal, descuento,\n  estado: 'activo',\n  categoria_id: categoriaId,\n  stock: producto.stock || 10,\n  // Especificaciones\n  peso: especificacionesProcesadas.peso, dimensiones: especificacionesProcesadas.dimensiones, marca: especificacionesProcesadas.marca, modelo: especificacionesProcesadas.modelo, color: especificacionesProcesadas.color, talla: especificacionesProcesadas.talla, material: especificacionesProcesadas.material, garantia_meses: especificacionesProcesadas.garantia_meses, origen_pais: especificacionesProcesadas.origen_pais,\n  // SEO y metadatos\n  palabras_clave: producto.palabras_clave || null, meta_title: producto.meta_title || producto.nombre || 'Producto', meta_description: producto.meta_description || producto.descripcion || 'Producto disponible',\n  // Fechas\n  creado_el: new Date().toISOString(), actualizado_el: new Date().toISOString(),\n  // Landing\n  landing_tipo: 'temu', numero_de_ventas: 0, calificacion_promedio: 0, total_resenas: 0,\n  // ðŸ”¥ CAMPOS JSON COMPLETOS (normalizados a objeto si vienen como string)\n  banner_animado: parseObjeto(producto.banner_animado),\n  puntos_dolor: parseObjeto(producto.puntos_dolor),\n  caracteristicas: parseObjeto(producto.caracteristicas),\n  testimonios: parseObjeto(producto.testimonios),\n  faq: parseObjeto(producto.faq),\n  garantias: parseObjeto(producto.garantias),\n  cta_final: parseObjeto(producto.cta_final),\n  promociones: parseObjeto(producto.promociones),\n  // ðŸ”¥ NUEVOS CAMPOS JSONB (paso previo)\n  ventajas: parseObjeto(producto.ventajas),\n  beneficios: parseObjeto(producto.beneficios)\n};\n\nconsole.log('âœ… PRODUCTO PROCESADO EXITOSAMENTE');\nconsole.log('ðŸ“‹ Nombre:', productoProcesado.nombre);\nconsole.log('ðŸ’° Precio:', productoProcesado.precio);\nconsole.log('ðŸ·ï¸ CategorÃ­a:', categoriaNombre);\nconsole.log('ðŸ“Š Campos JSON normalizados:', {\n  puntos_dolor: !!productoProcesado.puntos_dolor,\n  testimonios: !!productoProcesado.testimonios,\n  faq: !!productoProcesado.faq,\n  garantias: !!productoProcesado.garantias,\n  cta_final: !!productoProcesado.cta_final,\n  promociones: !!productoProcesado.promociones\n});\n\nreturn { json: { producto_procesado: productoProcesado, categoria_nombre: categoriaNombre, imagenes_procesadas: imagenesProcesadas, procesamiento_exitoso: true } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2208,
        992
      ],
      "id": "5a1612be-ea18-4ee4-ae6a-bd2c8b7f8f2f",
      "name": "Procesador JSON1"
    }
  ],
  "connections": {
    "Procesador JSON1": {
      "main": [
        []
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "8000b702e0a3d9ac6d70099a2751603316de4028cd14af0949776a26efecb219"
  }
}