{
  "nodes": [
    {
      "parameters": {
        "jsCode": "// ðŸ”„ PREPARAR JSON PARA SUPABASE - JSONB LIMPIO (SIN STRINGS)\nconsole.log('ðŸ”§ PREPARANDO JSON PARA SUPABASE');\n\nconst entrada = $input.first();\nconst producto = entrada.json.producto_procesado || entrada.json.producto || entrada.json;\n\nconsole.log('ðŸ“¥ Producto recibido:', producto?.nombre);\nconsole.log('ðŸ“‹ Campos disponibles:', producto ? Object.keys(producto) : []);\n\nfunction aObjeto(val, fallback) {\n  try {\n    if (!val) return fallback;\n    if (typeof val === 'string') {\n      const parsed = JSON.parse(val);\n      return parsed && typeof parsed === 'object' ? parsed : fallback;\n    }\n    if (typeof val === 'object') return val;\n    return fallback;\n  } catch (e) {\n    return fallback;\n  }\n}\n\nfunction estadoSeguro(e) {\n  const s = (typeof e === 'string' ? e.trim().toLowerCase() : '');\n  return s && ['nuevo','activo','inactivo','en_revision','borrador'].includes(s) ? s : 'nuevo';\n}\n\nconst defaultBannerAnimado = { mensajes: ['ðŸšš EnvÃ­o disponible','ðŸ’³ Compra segura','ðŸ›¡ï¸ GarantÃ­a real'], textColor: '#FFFFFF', velocidad: 'normal', backgroundColor: '#FF4444' };\nconst defaultPuntosDolor = { titulo: 'Â¿Te identificas con estos problemas?', subtitulo: 'CÃ³mo este producto ayuda en el dÃ­a a dÃ­a', timeline: [] };\nconst defaultTestimonios = { titulo: 'Lo que dicen nuestros clientes', subtitulo: 'Opiniones verificadas', testimonios: [], estadisticas: { recomiendan: 0, satisfaccion: 0, totalClientes: 0 } };\nconst defaultFaq = { titulo: 'Preguntas Frecuentes', subtitulo: 'Resolvemos tus dudas', preguntas: [] };\nconst defaultGarantias = { titulo: 'Compra Segura', subtitulo: 'Coberturas y soporte real', items: [] };\nconst defaultCtaFinal = { titulo: 'Listo para tenerlo', subtitulo: 'Aprovecha el precio actual', beneficios: ['Compra segura','Soporte real','Entrega confiable'], texto_boton: 'Comprar ahora', precio_actual: typeof producto?.precio === 'number' ? producto.precio : 0, precio_original: typeof producto?.precio_original === 'number' ? producto.precio_original : 0 };\nconst defaultPromociones = { titulo: 'Promociones Exclusivas por Cantidad', subtitulo: 'Maximiza tu inversiÃ³n con descuentos por volumen', promociones: [ { id: 1, activa: true, descripcion: 'Descuento del 10% al comprar 2 unidades', cantidadMinima: 2, descuentoPorcentaje: 10 }, { id: 2, activa: true, descripcion: 'Descuento del 15% al comprar 3 unidades', cantidadMinima: 3, descuentoPorcentaje: 15 } ] };\n\nconst defaultCaracteristicas = { titulo: 'Â¿Por quÃ© miles de personas eligen nuestro producto?', subtitulo: 'Descubre las caracterÃ­sticas que lo hacen Ãºnico y especial', imagen: '', detalles: [ { id: 1, icono: 'âš™ï¸', titulo: 'Material premium', descripcion: 'Resistente y duradero' }, { id: 2, icono: 'ðŸ§©', titulo: 'DiseÃ±o inteligente', descripcion: 'ErgonomÃ­a y facilidad de uso' }, { id: 3, icono: 'ðŸ”‹', titulo: 'Eficiencia energÃ©tica', descripcion: 'Optimiza consumo sin perder rendimiento' }, { id: 4, icono: 'ðŸ’¡', titulo: 'FÃ¡cil de usar', descripcion: 'PrÃ¡ctico y conveniente' } ], cta: { texto: 'Â¡QUIERO APROVECHAR ESTA OFERTA!', subtexto: 'ðŸ”¥ Oferta por tiempo limitado' } };\nconst defaultVentajas = { titulo: 'Â¿Por quÃ© elegir este producto?', subtitulo: 'Ventajas clave', items: [ { id: 1, icono: 'âœ…', titulo: 'Excelente relaciÃ³n calidad/precio', descripcion: 'Equilibrio ideal entre costo y prestaciones' }, { id: 2, icono: 'âš¡', titulo: 'Rendimiento confiable', descripcion: 'Funciona como se espera en uso diario' }, { id: 3, icono: 'ðŸ“ˆ', titulo: 'Mejora inmediata', descripcion: 'Resultados visibles desde el primer uso' } ] };\nconst defaultBeneficios = { titulo: 'Beneficios clave', subtitulo: 'Lo que obtienes al comprar', items: [ { id: 1, icono: 'ðŸ›¡ï¸', titulo: 'GarantÃ­a oficial', descripcion: 'Cobertura de satisfacciÃ³n y calidad' }, { id: 2, icono: 'ðŸ¤', titulo: 'Soporte dedicado', descripcion: 'AcompaÃ±amiento inicial y guÃ­a de uso' }, { id: 3, icono: 'ðŸšš', titulo: 'EnvÃ­o seguro', descripcion: 'Seguimiento y entrega confiable' } ] };\n\nfunction asegurarTresItemsBeneficios(obj) { const base = aObjeto(obj, defaultBeneficios); if (!Array.isArray(base.items)) base.items = defaultBeneficios.items; if (base.items.length > 3) base.items = base.items.slice(0, 3); if (base.items.length < 3) { const faltantes = 3 - base.items.length; base.items = base.items.concat(defaultBeneficios.items.slice(0, faltantes)); } return base; }\nfunction asegurarCaracteristicasMinimas(obj) { const base = aObjeto(obj, defaultCaracteristicas); if (!Array.isArray(base.detalles)) base.detalles = defaultCaracteristicas.detalles; if (base.detalles.length < 4) { const faltantes = 4 - base.detalles.length; base.detalles = base.detalles.concat(defaultCaracteristicas.detalles.slice(0, faltantes)); } if (base.detalles.length > 4) base.detalles = base.detalles.slice(0, 4); return base; }\n\nconst productoParaSupabase = {\n  nombre: producto?.nombre, slug: producto?.slug, descripcion: producto?.descripcion, ganchos: producto?.ganchos, precio: producto?.precio, precio_original: producto?.precio_original, descuento: producto?.descuento, estado: estadoSeguro(producto?.estado), categoria_id: producto?.categoria_id, stock: producto?.stock, peso: producto?.peso, dimensiones: producto?.dimensiones, marca: producto?.marca, modelo: producto?.modelo, color: producto?.color, talla: producto?.talla, material: producto?.material, garantia_meses: producto?.garantia_meses, origen_pais: producto?.origen_pais, palabras_clave: producto?.palabras_clave, meta_title: producto?.meta_title, meta_description: producto?.meta_description, creado_el: producto?.creado_el, actualizado_el: producto?.actualizado_el, landing_tipo: producto?.landing_tipo || 'temu', numero_de_ventas: producto?.numero_de_ventas || 0, calificacion_promedio: producto?.calificacion_promedio || 0, total_resenas: producto?.total_resenas || 0,\n  banner_animado: aObjeto(producto?.banner_animado, defaultBannerAnimado), puntos_dolor: aObjeto(producto?.puntos_dolor, defaultPuntosDolor), testimonios: aObjeto(producto?.testimonios, defaultTestimonios), faq: aObjeto(producto?.faq, defaultFaq), garantias: aObjeto(producto?.garantias, defaultGarantias), cta_final: aObjeto(producto?.cta_final, defaultCtaFinal), promociones: aObjeto(producto?.promociones, defaultPromociones),\n  caracteristicas_jsonb: asegurarCaracteristicasMinimas(producto?.caracteristicas_jsonb || producto?.caracteristicas), ventajas_jsonb: aObjeto(producto?.ventajas_jsonb || producto?.ventajas, defaultVentajas), beneficios_jsonb: asegurarTresItemsBeneficios(producto?.beneficios_jsonb || producto?.beneficios)\n};\n\nconsole.log('âœ… Producto preparado para Supabase');\nconsole.log('   - estado:', productoParaSupabase.estado);\nconsole.log('   - caracteristicas_jsonb es objeto:', typeof productoParaSupabase.caracteristicas_jsonb === 'object');\nconsole.log('   - ventajas_jsonb es objeto:', typeof productoParaSupabase.ventajas_jsonb === 'object');\nconsole.log('   - beneficios_jsonb items:', productoParaSupabase.beneficios_jsonb?.items?.length);\nconsole.log('   - promociones es objeto:', typeof productoParaSupabase.promociones === 'object');\n\nreturn { json: { producto_para_supabase: productoParaSupabase, conversion_exitosa: true } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1920,
        992
      ],
      "id": "da895f0b-8009-42bf-a780-4ef9e7c4f014",
      "name": "Preparar JSON para Supabase1"
    }
  ],
  "connections": {
    "Preparar JSON para Supabase1": {
      "main": [
        []
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "8000b702e0a3d9ac6d70099a2751603316de4028cd14af0949776a26efecb219"
  }
}